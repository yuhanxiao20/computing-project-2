---
title: "Project 2"
author: "Yuhan Xiao"
output: html_document
date: "2023-10-01"
---

## Background 
```{r message = FALSE}
library(here)
library(tidyverse)
library(lubridate)
library(ggplot2)
```

## Part 1: Fun with functions
#### Part 1A: Exponential transformation
```{r part_1A}
# define a function Exp(x,k) that computes the exponential of a number using the truncated series expansion
# parameters
# x : the number to be exponentiated
# k : the number of terms to be used in the series expansion beyond the constant 1, k is always >= 1
Exp <- function(x,k) {
  output = 1
  count = 1
  while (count <= k) {
    output = output + (x^count)/factorial(count)
    count = count + 1
  }
  output
}

# an example using function Exp(x,k)
Exp(2,15)
# compare with actual exp() function in R
exp(2)
```

#### Part 1B: Sample mean and sample standard deviation
```{r part_1B}
# define a function sample_mean(x) that calculates the sample average for a vector of data of length N
# parameter
# x : a vector of numbers of length N
sample_mean <- function(x) {
  N = length(x)
  output = sum(x) / N
  output
} 

# define a function sample_sd(x) that calculates the sample standard deviation for a vector of data of length N
# parameter
# x : a vector of numbers of length N
sample_sd <- function(x) {
  N = length(x)
  avg = sum(x) / N
  output = 0
  for (i in 1:N) {
    output = output + (x[i] - avg)^2
  }
  output = sqrt(output/(N-1))
  output
}

# an example using functions sample_mean(x) and sample_sd(x)
x = c(1,2)
sample_mean(x)
sample_sd(x)
# compare with actual mean() and sd() functions in R
mean(x)
sd(x)
```

#### Part 1C: Confidence intervals
```{r part_1C}
# define a function calculate_CI(x, conf) that calculates the confidence interval for a vector of data of length N
# parameter
# x : a vector of numbers of length N
# conf : = (1-alpha) allows the confidence interval to be adapted for different alpha, with a default value of 0.95
calculate_CI <- function(x, conf = 0.95) {
  alpha = 1 - conf
  N = length(x)
  degrees_freedom = N - 1
  t_score = qt(p = alpha / 2, df = degrees_freedom, lower.tail = FALSE)
  avg = mean(x)
  se = sd(x)/sqrt(N)
  output = c(avg - t_score*se, avg + t_score*se)
  output
}

# an example using calculate_CI(x, conf)
x = c(1,2,3,4,5,6)
calculate_CI(x)
# compare with existing confint() function in R
dat <- data.frame(x = x)
fit <- lm(x ~ 1, dat)
## Calculate a 95% confidence interval
confint(fit, level = 0.95)
```

## Part 2: Wrangling data
```{r part_2_setup}
# read in the following data from TidyTuesday
if (!file.exists(here("data", "tuesdata_rainfall.RDS"))) {
    tuesdata <- tidytuesdayR::tt_load("2020-01-07")
    rainfall <- tuesdata$rainfall
    temperature <- tuesdata$temperature

    # save the files to RDS objects
    saveRDS(tuesdata$rainfall, file = here("data", "tuesdata_rainfall.RDS"))
    saveRDS(tuesdata$temperature, file = here("data", "tuesdata_temperature.RDS"))
}

# load the datasets
rainfall <- readRDS(here("data", "tuesdata_rainfall.RDS"))
temperature <- readRDS(here("data", "tuesdata_temperature.RDS"))

# take a look at the data
glimpse(rainfall)
glimpse(temperature)
```

```{r part_2_tasks}
df <- rainfall %>%
  na.omit() %>% # drop any rows with NAs
  mutate(date = ymd(paste(year, month, day, sep = "-"))) %>% # create a new column that combines year, month, day
  select(-(month:day)) %>% # drop columns month and year
  mutate(city_name = toupper(city_name)) # convert city names to all upper case

# join this wrangled rainfall dataset with the temperature dataset
df <- df %>%
  inner_join(temperature, by = c("city_name", "date"), relationship = "many-to-many")

# check datasets
# glimpse(df)
# sum(duplicated(df[c("city_name","date")]))
# sum(duplicated(temperature[c("city_name","date")]))
# sum(duplicated(rainfall))
```

## Part 3: Data visualization
#### Part 3A: Plotting temperature data over time
```{r part_3A}
# filter out rows with years 2014 and onwards
data <- df %>%
  filter(year >= 2014)

# make a line plot of the max and min temperature over time for each city
ggplot(data, aes(x = date, y = temperature, color = temp_type)) +
  geom_line(size = 1) +
  scale_colour_manual(values = c("#FAAB18", "#1380A1")) +
  facet_wrap(~city_name, nrow = 3, scales="fixed") +
  labs(title="Maximum and Minimum Temperature Changes over Time Per City", subtitle="key trends summary", caption="Yuhan Xiao", x = "Year", y = "Temperature") +
  theme_minimal(base_size = 14) +
  theme(plot.title = element_text(hjust = 0.5, vjust = 1, size=15), 
        axis.text.x = element_text(angle = 45, hjust = 1))
```

#### Part 3B: Plotting rainfall over time
```{r part_3B}
# define a function that plots a histogram of rainfall distribution for a given city in a given year
# parameters
# city : the given city (all upper case)
# yr : the given year
# description
# ?????/
plot_rainfall <- function(city, yr) {
  # check if user inputs are valid
  city_names <- unique(df$city_name)
  year_range <- unique(df$year)
  if (!(city %in% city_names)) {
    stop(paste(city, " does not exist in the dataset", sep = ""))
  } else if (!(yr %in% year_range)) {
    stop(paste(yr, " does not exist in the dataset", sep = ""))
  }
  
  # select data with the given city and year
  data <- df %>%
    filter(city_name == city, year == yr)
  # check if the combination of city and year has measurements
  if (nrow(data) == 0) {
    stop(paste("The combination of ", city, " and ", yr, " does not have measurements", sep = ""))
  }
  
  # plot the histogram
  hist_plot <- data %>%
    ggplot(aes(log(rainfall))) +
    geom_histogram(binwidth = 0.5, color = "#FAAB18", fill = "#FAAB18") +
    labs(title=paste("Distribution of Rainfall (Log Scale) for ",city, " in Year ", yr, sep=""), subtitle="key trends summary", caption="Yuhan Xiao", x = "Rainfall (log scale)", y = "Frequency") +
    theme_minimal(base_size = 14) +
    theme(plot.title = element_text(hjust = 0.5, vjust = 1, size=15))
  hist_plot
}

# an example of using plot_rainfall(city, yr)
plot_rainfall("PERTH", 1970)
```

## Part 4: Apply functions and plot
#### Part 4A
```{r part_4A}
```

#### Part 4B
```{r part_4B}
```